<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì í”„ì—ê·¸ - ì•Œì—ì„œ í”¼ë‹‰ìŠ¤ê¹Œì§€</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050510;--accent:#fbbf24;--blue:#4f8fff;
  --glow:rgba(251,191,36,0.15);
}
html{scroll-behavior:smooth}
body{
  background:var(--bg);color:#e8e0f0;
  font-family:'Noto Sans KR',sans-serif;
  overflow-x:hidden;
  -webkit-user-select:none;user-select:none;
}
/* === HERO === */
.hero{
  min-height:100vh;display:flex;flex-direction:column;
  align-items:center;justify-content:center;text-align:center;
  position:relative;overflow:hidden;
  padding:40px 20px;
}
.hero::before{
  content:'';position:absolute;inset:0;
  background:
    radial-gradient(ellipse at 30% 20%,rgba(80,60,180,0.15) 0%,transparent 60%),
    radial-gradient(ellipse at 70% 80%,rgba(251,191,36,0.08) 0%,transparent 50%);
  pointer-events:none;
}
.hero-egg{font-size:120px;animation:float 3s ease-in-out infinite;position:relative;z-index:1}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
.hero h1{
  font-size:clamp(2.2rem,6vw,3.5rem);font-weight:900;
  background:linear-gradient(135deg,#ffd700,#ff8c20,#fbbf24);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  margin:20px 0 12px;line-height:1.2;position:relative;z-index:1;
}
.hero .subtitle{
  font-size:clamp(0.95rem,2.5vw,1.15rem);color:rgba(255,255,255,0.5);
  font-weight:300;line-height:1.8;max-width:420px;position:relative;z-index:1;
}
.hero .subtitle em{color:var(--accent);font-style:normal;font-weight:700}
.cta-btn{
  display:inline-flex;align-items:center;gap:8px;
  margin-top:36px;padding:16px 40px;
  background:linear-gradient(135deg,#fbbf24,#f97316);
  color:#1a0a00;font-size:1.05rem;font-weight:800;
  border:none;border-radius:60px;cursor:pointer;
  transition:all .25s;position:relative;z-index:1;
  text-decoration:none;
  box-shadow:0 4px 30px rgba(251,191,36,0.3);
}
.cta-btn:hover{transform:translateY(-2px);box-shadow:0 8px 40px rgba(251,191,36,0.5)}
.scroll-hint{
  position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
  color:rgba(255,255,255,0.2);font-size:0.75rem;
  animation:bob 2s ease-in-out infinite;
}
@keyframes bob{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(8px)}}

/* === STORY === */
.story{padding:100px 20px;max-width:680px;margin:0 auto;position:relative}
.story::before{
  content:'';position:absolute;left:50%;top:0;bottom:0;width:2px;
  background:linear-gradient(to bottom,transparent,rgba(251,191,36,0.2),transparent);
  transform:translateX(-50%);
}
.story-step{
  display:flex;gap:24px;align-items:flex-start;margin-bottom:60px;
  opacity:0;transform:translateY(30px);
  animation:fadeUp .6s forwards;
}
.story-step:nth-child(1){animation-delay:.1s}
.story-step:nth-child(2){animation-delay:.25s}
.story-step:nth-child(3){animation-delay:.4s}
.story-step:nth-child(4){animation-delay:.55s}
.story-step:nth-child(5){animation-delay:.7s}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
.story-icon{
  flex-shrink:0;width:60px;height:60px;
  display:flex;align-items:center;justify-content:center;
  font-size:32px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;position:relative;z-index:1;
}
.story-text h3{font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:6px}
.story-text p{font-size:0.92rem;color:rgba(255,255,255,0.55);line-height:1.7;font-weight:300}

/* === HOW TO PLAY === */
.howto{
  padding:80px 20px;
  background:linear-gradient(180deg,transparent,rgba(30,20,60,0.4),transparent);
}
.section-title{
  text-align:center;font-size:clamp(1.5rem,4vw,2rem);font-weight:900;
  margin-bottom:50px;color:#fff;
}
.section-title span{color:var(--accent)}
.cards{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;max-width:800px;margin:0 auto;
}
.card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:20px;padding:28px 22px;
  transition:all .3s;
}
.card:hover{background:rgba(255,255,255,0.06);transform:translateY(-4px)}
.card-icon{font-size:2.2rem;margin-bottom:12px}
.card h4{font-size:0.95rem;font-weight:700;color:#fff;margin-bottom:8px}
.card p{font-size:0.82rem;color:rgba(255,255,255,0.45);line-height:1.6;font-weight:300}
.card .key{
  display:inline-block;padding:2px 10px;margin-top:8px;
  background:rgba(255,255,255,0.08);border-radius:6px;
  font-size:0.75rem;color:rgba(255,255,255,0.6);
  font-family:monospace;
}

/* === EVOLUTION === */
.evo-section{padding:60px 20px;text-align:center}
.evo-track{
  display:flex;align-items:center;justify-content:center;
  gap:8px;flex-wrap:wrap;margin-top:30px;
}
.evo-item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:12px 10px;border-radius:14px;
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.04);
  min-width:60px;transition:all .3s;
}
.evo-item:hover{background:rgba(255,255,255,0.06);transform:scale(1.08)}
.evo-emoji{font-size:2rem}
.evo-name{font-size:0.7rem;color:rgba(255,255,255,0.5);font-weight:700}
.evo-xp{font-size:0.6rem;color:rgba(255,255,255,0.25)}
.evo-arrow{color:rgba(255,255,255,0.15);font-size:1.2rem}

/* === GAME SECTION === */
.game-section{
  padding:60px 20px 40px;
  display:flex;flex-direction:column;align-items:center;
  background:linear-gradient(180deg,transparent,rgba(10,5,30,0.5));
}
.game-section .section-title{margin-bottom:20px}
#game-wrapper{
  display:flex;flex-direction:column;align-items:center;
  gap:8px;
}
#top-bar{
  width:400px;max-width:calc(100vw - 16px);
  padding:8px 14px;
  background:rgba(255,255,255,0.04);
  border-radius:10px;
  color:#fff;font-size:12px;font-family:monospace;
}
#top-bar .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
#xp-bar-outer{position:relative;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden}
#xp-bar-fill{height:100%;width:0%;border-radius:3px;transition:width .05s linear}
#xp-info{display:flex;justify-content:space-between;margin-top:3px;font-size:9px;opacity:.35}
#game-canvas{
  border-radius:14px;cursor:pointer;
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 4px 40px rgba(0,0,0,0.6);
  max-width:100%;touch-action:manipulation;
}
#evo-roadmap{
  display:flex;gap:6px;padding:6px 14px;
  background:rgba(255,255,255,0.03);border-radius:10px;
  align-items:center;
}
.evo-road-item{display:flex;flex-direction:column;align-items:center;transition:all .4s}
.evo-road-label{font-size:7px;font-weight:bold;margin-top:1px}
#game-hint{
  color:rgba(255,255,255,0.2);font-size:10px;margin-top:10px;
  text-align:center;line-height:1.6;
}

/* === FOOTER === */
.foot{
  text-align:center;padding:60px 20px 30px;
  color:rgba(255,255,255,0.15);font-size:0.75rem;
}

/* Stars background */
.stars{position:fixed;inset:0;pointer-events:none;z-index:0}
.stars span{
  position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;
  animation:twinkle 3s ease-in-out infinite alternate;
}
@keyframes twinkle{0%{opacity:0.1}100%{opacity:0.6}}
</style>
</head>
<body>

<!-- Twinkling stars background -->
<div class="stars" id="stars-bg"></div>

<!-- ========== HERO ========== -->
<section class="hero" id="top">
  <div class="hero-egg">ğŸ¥š</div>
  <h1>ì í”„ì—ê·¸</h1>
  <p class="subtitle">
    ì‘ì€ <em>ì•Œ</em> í•˜ë‚˜ê°€ ëì—†ëŠ” ìš°ì£¼ë¥¼ í–¥í•´ ì í”„í•©ë‹ˆë‹¤.<br>
    ë†’ì´ ì˜¤ë¥¼ìˆ˜ë¡ <em>ì§„í™”</em>í•˜ê³ , ë” ê°•í•´ì§€ê³ , ë” ë©€ë¦¬ ë‚ ì•„ê°‘ë‹ˆë‹¤.<br>
    í”¼ë‹‰ìŠ¤ê°€ ë  ë•Œê¹Œì§€ â€” ë©ˆì¶”ì§€ ë§ˆì„¸ìš”.
  </p>
  <a href="#game" class="cta-btn">ğŸ® ì§€ê¸ˆ í”Œë ˆì´</a>
  <div class="scroll-hint">â†“ ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ì•Œì•„ë³´ê¸°</div>
</section>

<!-- ========== STORY ========== -->
<section class="story">
  <div class="story-step">
    <div class="story-icon">ğŸ¥š</div>
    <div class="story-text">
      <h3>íƒ„ìƒ</h3>
      <p>ê¹Šì€ ìš°ì£¼ ì–´ë”˜ê°€, ì‘ì€ ì•Œ í•˜ë‚˜ê°€ ë– ë‹¤ë‹ˆëŠ” ë°œíŒ ìœ„ì— ë†“ì—¬ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ ì•Œì€ í‰ë²”í•´ ë³´ì´ì§€ë§Œ, ê·¸ ì•ˆì—ëŠ” ë¬´í•œí•œ ì ì¬ë ¥ì´ ìˆ¨ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
    </div>
  </div>
  <div class="story-step">
    <div class="story-icon">âš¡</div>
    <div class="story-text">
      <h3>ì í”„ì˜ í˜</h3>
      <p>ì•Œì€ í˜ì„ ëª¨ì•„ ì í”„í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ê¾¹ ëˆ„ë¥´ë©´ ì—ë„ˆì§€ê°€ ì°¨ì˜¤ë¥´ê³ , ì ì ˆí•œ íƒ€ì´ë°ì— ë†“ìœ¼ë©´ í•˜ëŠ˜ ë†’ì´ ì†Ÿì•„ì˜¤ë¥¼ ìˆ˜ ìˆì£ . 100% íŒŒì›Œë¡œ ì í”„í•˜ë©´? íŠ¹ë³„í•œ ì¼ì´ ë²Œì–´ì§‘ë‹ˆë‹¤.</p>
    </div>
  </div>
  <div class="story-step">
    <div class="story-icon">âœ¨</div>
    <div class="story-text">
      <h3>ì§„í™”</h3>
      <p>ë†’ì´ ì˜¤ë¥¼ìˆ˜ë¡ ê²½í—˜ì¹˜ê°€ ìŒ“ì´ê³ , ì•Œì€ ë³‘ì•„ë¦¬ë¡œ, ë…ìˆ˜ë¦¬ë¡œ, ë“œë˜ê³¤ìœ¼ë¡œ ì§„í™”í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ë°©ì‹¬í•˜ë©´ ê²½í—˜ì¹˜ê°€ ì¤„ì–´ ë‹¤ì‹œ í‡´í™”í•  ìˆ˜ë„ ìˆì–´ìš”. ëŠì„ì—†ì´ ë„ì „í•˜ì„¸ìš”!</p>
    </div>
  </div>
  <div class="story-step">
    <div class="story-icon">âš ï¸</div>
    <div class="story-text">
      <h3>ìœ„í—˜í•œ ë°œíŒë“¤</h3>
      <p>ìš°ì£¼ì—ëŠ” ì•ˆì „í•œ ê³³ë§Œ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. 5ì´ˆ í›„ ì‚¬ë¼ì§€ëŠ” ì‹œí•œë¶€ ë°œíŒ, í•œ ë²ˆë§Œ ë°Ÿì„ ìˆ˜ ìˆëŠ” ë‚˜ë¬´ ë°œíŒ, ê·¸ë¦¬ê³  ë‚ ì•„ë‹¤ë‹ˆëŠ” ìƒˆë“¤ê¹Œì§€. ë†’ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” í—˜ë‚œí•´ì§‘ë‹ˆë‹¤.</p>
    </div>
  </div>
  <div class="story-step">
    <div class="story-icon">ğŸ”¥</div>
    <div class="story-text">
      <h3>í”¼ë‹‰ìŠ¤ë¥¼ í–¥í•´</h3>
      <p>ìµœì¢… ëª©í‘œëŠ” ì „ì„¤ì˜ í”¼ë‹‰ìŠ¤ë¡œ ì§„í™”í•˜ëŠ” ê²ƒ. 260 XPë¥¼ ëª¨ì•„ ë¶ˆì‚¬ì¡°ê°€ ë˜ì–´ ìš°ì£¼ ëê¹Œì§€ ë‚ ì•„ì˜¤ë¥´ì„¸ìš”. ë‹¹ì‹ ì˜ ì•Œì€ ì–´ë””ê¹Œì§€ ê°ˆ ìˆ˜ ìˆì„ê¹Œìš”?</p>
    </div>
  </div>
</section>

<!-- ========== HOW TO PLAY ========== -->
<section class="howto" id="howto">
  <h2 class="section-title">ğŸ•¹ï¸ <span>ê²Œì„ ë°©ë²•</span></h2>
  <div class="cards">
    <div class="card">
      <div class="card-icon">ğŸ”‹</div>
      <h4>íŒŒì›Œ ì¶©ì „</h4>
      <p>ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ê¾¹ ëˆ„ë¥´ë©´ íŒŒì›Œ ê²Œì´ì§€ê°€ ì¶©ì „ë©ë‹ˆë‹¤. 60~85% êµ¬ê°„ì´ ìŠ¤ìœ„íŠ¸ ìŠ¤íŒŸ!</p>
      <span class="key">SPACE ê¾¹ ëˆ„ë¥´ê¸°</span>
    </div>
    <div class="card">
      <div class="card-icon">ğŸš€</div>
      <h4>ì í”„!</h4>
      <p>ì ì ˆí•œ íƒ€ì´ë°ì— ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ë†“ìœ¼ë©´ ì í”„! ë°œíŒì˜ ì´ë™ ë°©í–¥ìœ¼ë¡œ ê´€ì„±ì´ ë¶™ì–´ìš”.</p>
      <span class="key">SPACE ë†“ê¸°</span>
    </div>
    <div class="card">
      <div class="card-icon">ğŸ’¯</div>
      <h4>í¼í™íŠ¸ ì í”„</h4>
      <p>íŒŒì›Œ 99~100%ì—ì„œ ì í”„í•˜ë©´ í™©ê¸ˆ í­ë°œê³¼ í•¨ê»˜ ë³´ë„ˆìŠ¤ +5 XP! í™”ë©´ì´ ë²ˆì©í•©ë‹ˆë‹¤.</p>
    </div>
    <div class="card">
      <div class="card-icon">â±ï¸</div>
      <h4>ì‹œí•œë¶€ ë°œíŒ</h4>
      <p>ì–´ë‘ìš´ ëŒ ë°œíŒ â€” ì˜¬ë¼ì„œë©´ 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘. ë‚´ë ¤ì˜¤ë©´ ì¼ì‹œì •ì§€ë©ë‹ˆë‹¤.</p>
    </div>
    <div class="card">
      <div class="card-icon">ğŸªµ</div>
      <h4>ë‚˜ë¬´ ë°œíŒ</h4>
      <p>ê¸ˆë¹›ìœ¼ë¡œ ë¹›ë‚˜ëŠ” ë‚˜ë¬´ ì¡°ê° â€” ì í”„í•˜ë©´ ì¦‰ì‹œ ë¶€ì„œì§‘ë‹ˆë‹¤. í•œ ë²ˆë§Œ ë°Ÿì„ ìˆ˜ ìˆì–´ìš”!</p>
    </div>
    <div class="card">
      <div class="card-icon">ğŸ¦…</div>
      <h4>ìƒˆ ì¥ì• ë¬¼</h4>
      <p>40m ì´ìƒì—ì„œ ë“±ì¥. ë¶€ë”ªíˆë©´ ì™¼ìª½ìœ¼ë¡œ ë°€ë ¤ë‚˜ìš”. ë†’ì„ìˆ˜ë¡ ë” ìì£¼ ë‚˜ì˜µë‹ˆë‹¤.</p>
    </div>
  </div>
</section>

<!-- ========== EVOLUTION ========== -->
<section class="evo-section">
  <h2 class="section-title">ğŸ§¬ <span>ì§„í™” ë‹¨ê³„</span></h2>
  <div class="evo-track">
    <div class="evo-item"><div class="evo-emoji">ğŸ¥š</div><div class="evo-name">ì•Œ</div><div class="evo-xp">0 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ£</div><div class="evo-name">ë³‘ì•„ë¦¬</div><div class="evo-xp">15 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ¥</div><div class="evo-name">ì•„ê¸°ìƒˆ</div><div class="evo-xp">40 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ”</div><div class="evo-name">ë‹­</div><div class="evo-xp">75 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ¦…</div><div class="evo-name">ë…ìˆ˜ë¦¬</div><div class="evo-xp">120 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ‰</div><div class="evo-name">ë“œë˜ê³¤</div><div class="evo-xp">180 XP</div></div>
    <div class="evo-arrow">â†’</div>
    <div class="evo-item"><div class="evo-emoji">ğŸ”¥</div><div class="evo-name">í”¼ë‹‰ìŠ¤</div><div class="evo-xp">260 XP</div></div>
  </div>
</section>

<!-- ========== GAME ========== -->
<section class="game-section" id="game">
  <h2 class="section-title">ğŸ® <span>í”Œë ˆì´</span></h2>
  <div id="game-wrapper">
    <div id="top-bar">
      <div class="row">
        <span id="ui-stage">ğŸ¥š <span style="color:#F9E4B7;font-weight:bold">ì•Œ</span></span>
        <span id="ui-score" style="color:#fbbf24;font-weight:bold">ğŸ“ 0m</span>
        <span id="ui-xp" style="opacity:.6;font-size:10px;color:#a78bfa">XP 0</span>
      </div>
      <div id="xp-bar-outer"><div id="xp-bar-fill"></div></div>
      <div id="xp-info">
        <span id="xp-from">0 XP</span>
        <span id="xp-next">ë‹¤ìŒ ì§„í™”: ğŸ£ ë³‘ì•„ë¦¬ (15 XP)</span>
      </div>
    </div>
    <canvas id="game-canvas"></canvas>
    <div id="evo-roadmap"></div>
    <div id="game-hint">
      ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ê¾¹ ëˆ„ë¥´ë©´ íŒŒì›Œ ì¶©ì „ Â· ë–¼ë©´ ì í”„!<br>
      â± ì‹œí•œë¶€ ë°œíŒ Â· ğŸªµ ì¼íšŒìš© ë°œíŒ Â· ğŸ¦… ìƒˆ ì¡°ì‹¬!
    </div>
  </div>
</section>

<footer class="foot">
  <p>ì í”„ì—ê·¸ Â· Jump Egg Â· ì•Œì—ì„œ í”¼ë‹‰ìŠ¤ê¹Œì§€ ğŸ”¥</p>
</footer>

<script>
// Generate twinkling stars
(function(){
  const c=document.getElementById('stars-bg');
  for(let i=0;i<60;i++){
    const s=document.createElement('span');
    s.style.left=Math.random()*100+'%';
    s.style.top=Math.random()*100+'%';
    s.style.animationDelay=Math.random()*3+'s';
    s.style.animationDuration=(2+Math.random()*3)+'s';
    s.style.width=s.style.height=(1+Math.random()*2)+'px';
    c.appendChild(s);
  }
})();

// ============ GAME ENGINE ============
(function(){
const W=400,H=650,GRAVITY=0.28,MAX_JUMP_VEL=11.5,PLATFORM_GAP=80,EGG_R=18;
const STAGES=[
  {emoji:"ğŸ¥š",name:"ì•Œ",need:0,color:"#F9E4B7"},
  {emoji:"ğŸ£",name:"ë³‘ì•„ë¦¬",need:15,color:"#FFEB3B"},
  {emoji:"ğŸ¥",name:"ì•„ê¸°ìƒˆ",need:40,color:"#FFC107"},
  {emoji:"ğŸ”",name:"ë‹­",need:75,color:"#FF9800"},
  {emoji:"ğŸ¦…",name:"ë…ìˆ˜ë¦¬",need:120,color:"#8D6E63"},
  {emoji:"ğŸ‰",name:"ë“œë˜ê³¤",need:180,color:"#E53935"},
  {emoji:"ğŸ”¥",name:"í”¼ë‹‰ìŠ¤",need:260,color:"#FFD700"},
];

function getStage(xp){for(let i=STAGES.length-1;i>=0;i--)if(xp>=STAGES[i].need)return i;return 0}

function createPlatform(y,index){
  const heightM=Math.max(0,Math.floor((540-y)/12));
  const widthBase=Math.max(50,130-heightM*0.35);
  const w=widthBase+Math.random()*Math.max(10,25-heightM*0.08);
  const baseSpeed=0.6+Math.min(1.2,heightM*0.008);
  const zigzag=index%2===0?0.6:1.0;
  const speed=baseSpeed*zigzag*(0.8+Math.random()*0.4)*(Math.random()>0.5?1:-1);
  let type="normal";
  if(heightM>=15){
    const tc=Math.min(0.18,(heightM-15)*0.003);
    const fc=Math.min(0.15,(heightM-15)*0.002);
    const r=Math.random();
    if(r<tc)type="timed";else if(r<tc+fc)type="fragile";
  }
  return{x:30+Math.random()*(W-60-w),y,w,h:11,speed,
    hue:type==="timed"?0:type==="fragile"?270:(index*37)%360,
    type,timer:type==="timed"?300:0,landed:false,removing:false};
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

const canvas=document.getElementById('game-canvas');
const ctx=canvas.getContext('2d');
const dpr=window.devicePixelRatio||1;
canvas.width=W*dpr;canvas.height=H*dpr;
canvas.style.width=W+'px';canvas.style.height=H+'px';
ctx.scale(dpr,dpr);

let evolveFlash=false;
const g={
  state:"idle",
  egg:{x:W/2,y:0,vx:0,vy:0,onPlatform:null},
  platforms:[],camera:{y:0},
  power:{value:50,dir:1,speed:1.6},
  score:0,highScore:0,xp:0,xpDecayTimer:0,
  stageIdx:0,prevStageIdx:0,
  particles:[],birds:[],birdTimer:0,
  perfectFlash:0,landingFx:null,
  heightReached:0,highestPlatformY:540,
};

function initGame(){
  const p=[];
  p.push({x:W/2-90,y:540,w:180,h:11,speed:0,hue:140,type:"normal",timer:0,landed:false,removing:false});
  for(let i=1;i<=25;i++)p.push(createPlatform(540-i*PLATFORM_GAP,i));
  g.platforms=p;
  g.egg={x:W/2,y:540-EGG_R,vx:0,vy:0,onPlatform:p[0]};
  g.camera={y:0};g.power={value:50,dir:1,speed:1.6};
  g.score=0;g.xp=0;g.xpDecayTimer=0;g.stageIdx=0;g.prevStageIdx=0;
  g.state="idle";g.particles=[];g.birds=[];g.birdTimer=0;
  g.perfectFlash=0;g.landingFx=null;g.heightReached=540;g.highestPlatformY=540;
  evolveFlash=false;updateUI();
}

function startCharging(){if(g.state!=="idle")return;g.power.value=0;g.power.dir=1;g.state="charging";}
function releaseJump(){
  if(g.state!=="charging")return;
  const pw=g.power.value/100,stageBonus=1+g.stageIdx*0.12;
  const jumpVel=MAX_JUMP_VEL*Math.max(0.15,pw)*stageBonus;
  const egg=g.egg,platVx=egg.onPlatform?egg.onPlatform.speed*0.35:0;
  if(egg.onPlatform&&egg.onPlatform.type==="fragile"){
    egg.onPlatform.removing=true;g.platforms=g.platforms.filter(p=>!p.removing);
  }
  egg.vy=-jumpVel;egg.vx=platVx;egg.onPlatform=null;g.state="jumping";
  const isPerfect=g.power.value>=99;
  if(isPerfect){
    g.perfectFlash=30;g.xp+=5;
    for(let i=0;i<24;i++){const a=(i/24)*Math.PI*2,s=3+Math.random()*4;
      g.particles.push({x:egg.x,y:egg.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,life:35+Math.random()*20,maxLife:55,size:3+Math.random()*5,hue:45+Math.random()*30});}
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2;
      g.particles.push({x:egg.x+Math.cos(a)*25,y:egg.y+Math.sin(a)*25,vx:Math.cos(a)*1.5,vy:Math.sin(a)*1.5-1,life:25+Math.random()*15,maxLife:40,size:2+Math.random()*3,hue:180+Math.random()*60});}
    g.landingFx={y:egg.y,x:egg.x,timer:40,text:"âœ¨ PERFECT! +5 XP âœ¨"};
  }else{
    for(let i=0;i<6;i++)g.particles.push({x:egg.x+(Math.random()-0.5)*16,y:egg.y+EGG_R,vx:(Math.random()-0.5)*3,vy:Math.random()*2+1,life:25+Math.random()*15,maxLife:40,size:2+Math.random()*3,hue:45});
  }
}

// UI Update
function updateUI(){
  const s=STAGES[g.stageIdx];
  document.getElementById('ui-stage').innerHTML=s.emoji+' <span style="color:'+s.color+';font-weight:bold">'+s.name+'</span>';
  document.getElementById('ui-score').textContent='ğŸ“ '+g.score+'m';
  document.getElementById('ui-xp').textContent='XP '+Math.floor(g.xp);
  const next=g.stageIdx<STAGES.length-1?STAGES[g.stageIdx+1]:null;
  const prev=STAGES[g.stageIdx].need;
  const nxt=next?next.need:STAGES[STAGES.length-1].need;
  const pct=next?Math.min(100,((g.xp-prev)/(nxt-prev))*100):100;
  const bar=document.getElementById('xp-bar-fill');
  bar.style.width=pct+'%';
  bar.style.background='linear-gradient(90deg,'+s.color+'AA,'+s.color+')';
  bar.style.boxShadow='0 0 8px '+s.color+'44';
  document.getElementById('xp-from').textContent=prev+' XP';
  document.getElementById('xp-next').textContent=next?'ë‹¤ìŒ ì§„í™”: '+next.emoji+' '+next.name+' ('+nxt+' XP)':'MAX!';
  // Roadmap
  let rm='';
  STAGES.forEach((st,i)=>{
    const active=g.xp>=st.need;const cur=i===g.stageIdx;
    rm+='<div class="evo-road-item" style="opacity:'+(active?1:0.25)+';filter:'+(active?'none':'grayscale(1)')+'"><span style="font-size:'+(cur?'1.5rem':'1rem')+'">'+st.emoji+'</span>';
    if(cur)rm+='<span class="evo-road-label" style="color:'+st.color+'">'+st.name+'</span>';
    rm+='</div>';
  });
  document.getElementById('evo-roadmap').innerHTML=rm;
}

// Main loop
let lastTime=0;
function loop(time){
  const dt=Math.min((time-lastTime)/16.67,2.5);lastTime=time;
  update(dt);render(ctx);requestAnimationFrame(loop);
}

function update(dt){
  if(g.state==="gameover")return;
  const{egg,platforms,camera,power}=g;
  if(g.state==="charging"){power.value+=power.dir*power.speed*dt;if(power.value>=100){power.value=100;power.dir=-1;}if(power.value<=0){power.value=0;power.dir=1;}}
  for(const p of platforms){if(p.speed===0)continue;p.x+=p.speed*dt;if(p.x<=8){p.x=8;p.speed=Math.abs(p.speed);}if(p.x+p.w>=W-8){p.x=W-8-p.w;p.speed=-Math.abs(p.speed);}}
  for(const p of platforms){if(p.type==="timed"&&p.landed&&egg.onPlatform===p){p.timer-=dt;if(p.timer<=0&&!p.removing){p.timer=0;p.removing=true;if(egg.onPlatform===p){egg.onPlatform=null;egg.vy=0;g.state="jumping";}}}}
  g.platforms=g.platforms.filter(p=>!(p.type==="timed"&&p.removing));
  g.birdTimer+=dt;
  const height=Math.max(0,Math.floor((540-g.heightReached)/12));
  let birdInterval=99999;
  if(height>=40&&height<80)birdInterval=500;
  else if(height>=80&&height<130)birdInterval=350;
  else if(height>=130&&height<200)birdInterval=250;
  else if(height>=200&&height<300)birdInterval=170;
  else if(height>=300)birdInterval=120;
  if(g.birdTimer>birdInterval){g.birdTimer=0;g.birds.push({x:W+30,y:camera.y+80+Math.random()*(H-200),speed:1.5+Math.random()*1.2+Math.min(2,height*0.01),frame:0});}
  for(const b of g.birds){b.x-=b.speed*dt;b.frame+=dt*0.15;const dx=egg.x-b.x,dy=egg.y-b.y;
    if(Math.abs(dx)<EGG_R+14&&Math.abs(dy)<EGG_R+8){egg.vx=-4;if(g.state==="idle"||g.state==="charging"){egg.onPlatform=null;egg.vy=-2;g.state="jumping";}b.x=-100;
    for(let i=0;i<6;i++)g.particles.push({x:egg.x,y:egg.y,vx:-(Math.random()*3+1),vy:(Math.random()-0.5)*3,life:15,maxLife:15,size:2+Math.random()*3,hue:30});}}
  g.birds=g.birds.filter(b=>b.x>-50);
  if((g.state==="idle"||g.state==="charging")&&g.xp>0){g.xpDecayTimer+=dt;g.xp=Math.max(0,g.xp-0.008*dt);const ns=getStage(Math.floor(g.xp));
    if(ns<g.stageIdx){for(let i=0;i<10;i++)g.particles.push({x:egg.x+(Math.random()-0.5)*30,y:egg.y+(Math.random()-0.5)*30,vx:(Math.random()-0.5)*3,vy:-(Math.random()*2),life:20+Math.random()*15,maxLife:35,size:2+Math.random()*3,hue:0});}
    g.stageIdx=ns;updateUI();}
  if((g.state==="idle"||g.state==="charging")&&egg.onPlatform){const ps=egg.onPlatform.y-camera.y;
    if(ps>H){egg.onPlatform=null;egg.vy=0;g.state="jumping";}
    else{egg.x+=egg.onPlatform.speed*dt;egg.x=Math.max(EGG_R,Math.min(W-EGG_R,egg.x));egg.y=egg.onPlatform.y-EGG_R;}}
  if(g.state==="jumping"){egg.vy+=GRAVITY*dt;egg.x+=egg.vx*dt;egg.y+=egg.vy*dt;
    if(egg.x<EGG_R){egg.x=EGG_R;egg.vx=Math.abs(egg.vx)*0.7;}
    if(egg.x>W-EGG_R){egg.x=W-EGG_R;egg.vx=-Math.abs(egg.vx)*0.7;}
    if(egg.vy<-1&&Math.random()>0.5){const pt=g.perfectFlash>0;
      g.particles.push({x:egg.x+(Math.random()-0.5)*10,y:egg.y+EGG_R+4,vx:(Math.random()-0.5)*(pt?2:0.5),vy:Math.random()*0.8+0.3,life:pt?25:15+Math.random()*10,maxLife:pt?35:25,size:pt?3+Math.random()*3:1.5+Math.random()*2,hue:pt?45+Math.random()*20:200});}
    if(egg.vy>0){const esY=egg.y-camera.y;if(esY<H+10){
      for(const p of platforms){const sy=p.y-camera.y;if(sy<-20||sy>H)continue;if(p.removing)continue;
        const prevY=egg.y-egg.vy*dt;
        if(prevY+EGG_R<=p.y+4&&egg.y+EGG_R>=p.y-2&&egg.x+EGG_R*0.6>p.x&&egg.x-EGG_R*0.6<p.x+p.w){
          egg.y=p.y-EGG_R;egg.vy=0;egg.vx=0;egg.onPlatform=p;g.state="idle";
          if(p.type==="timed")p.landed=true;
          if(p.y<g.highestPlatformY){g.xp+=3;g.highestPlatformY=p.y;g.landingFx={y:p.y,x:egg.x,timer:20,text:'+3 XP'};}
          else{g.landingFx={y:p.y,x:egg.x,timer:20,text:'SAFE'};}
          g.score=Math.max(g.score,Math.floor((540-p.y)/12));g.xpDecayTimer=0;
          for(let i=0;i<8;i++)g.particles.push({x:egg.x+(Math.random()-0.5)*20,y:p.y,vx:(Math.random()-0.5)*4,vy:-(Math.random()*2+0.5),life:20+Math.random()*15,maxLife:35,size:2+Math.random()*3,hue:p.hue});
          g.prevStageIdx=g.stageIdx;g.stageIdx=getStage(Math.floor(g.xp));
          if(g.stageIdx>g.prevStageIdx){evolveFlash=true;setTimeout(()=>{evolveFlash=false;},1200);
            for(let i=0;i<20;i++){const a=(i/20)*Math.PI*2;g.particles.push({x:egg.x,y:egg.y,vx:Math.cos(a)*(2+Math.random()*3),vy:Math.sin(a)*(2+Math.random()*3),life:30+Math.random()*20,maxLife:50,size:3+Math.random()*4,hue:50});}}
          updateUI();break;}}}}
    if(egg.y>camera.y+H+20){g.state="gameover";g.highScore=Math.max(g.highScore,g.score);updateUI();}}
  const tc=egg.y-H*0.55;if(tc<camera.y)camera.y+=(tc-camera.y)*0.07*dt;
  g.heightReached=Math.min(g.heightReached,egg.y);
  let minY=Math.min(...platforms.map(p=>p.y));
  while(minY>camera.y-300){const idx=platforms.length;const ny=minY-PLATFORM_GAP;platforms.push(createPlatform(ny,idx));minY=ny;}
  g.platforms=platforms.filter(p=>p.y<camera.y+H+50);
  for(const p of g.particles){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=0.05*dt;p.life-=dt;}
  g.particles=g.particles.filter(p=>p.life>0);
  if(g.landingFx){g.landingFx.timer-=dt;if(g.landingFx.timer<=0)g.landingFx=null;}
  if(g.perfectFlash>0)g.perfectFlash-=dt;
}

function render(c){
  const{egg,platforms,camera,power}=g;
  const bgG=c.createLinearGradient(0,0,0,H);bgG.addColorStop(0,"#070714");bgG.addColorStop(0.4,"#0d0d24");bgG.addColorStop(1,"#141432");c.fillStyle=bgG;c.fillRect(0,0,W,H);
  if(g.perfectFlash>0){const fa=Math.min(0.5,g.perfectFlash/20);const fg=c.createRadialGradient(W/2,H/2,0,W/2,H/2,W);fg.addColorStop(0,`rgba(255,230,100,${fa})`);fg.addColorStop(0.5,`rgba(255,180,50,${fa*0.5})`);fg.addColorStop(1,'rgba(255,100,30,0)');c.fillStyle=fg;c.fillRect(0,0,W,H);}
  for(let i=0;i<40;i++){const sx=(i*97.3+30)%W,sy=((i*137.5+camera.y*0.05*((i%3)+1))%(H+40)+H+40)%(H+40);c.fillStyle=`rgba(255,255,255,${0.15+(i%4)*0.08})`;c.beginPath();c.arc(sx,sy,0.8+(i%3)*0.4,0,Math.PI*2);c.fill();}
  const ht=Math.max(0,Math.floor((540-g.heightReached)/12));c.fillStyle="rgba(255,255,255,0.12)";c.font="bold 11px monospace";c.textAlign="right";c.fillText(ht+'m',W-12,20);
  if((g.state==="idle"||g.state==="charging")&&g.xp>0&&g.xpDecayTimer>120){const wa=0.3+Math.sin(Date.now()/200)*0.3;c.fillStyle=`rgba(255,80,80,${wa})`;c.font="bold 10px monospace";c.textAlign="center";c.fillText("âš  XP DECAYING...",W/2,18);}
  c.save();c.translate(0,-camera.y);
  // Platforms
  for(const p of platforms){const sy=p.y-camera.y;if(sy<-20||sy>H+20)continue;
    if(p.type==="timed"){
      const urg=p.landed?Math.max(0,p.timer/300):1;const pul=p.landed?0.5+Math.sin(Date.now()/(80+urg*150))*0.5:1;const secs=Math.max(0,Math.ceil(p.timer/60));const th=22,ty=p.y-6;
      c.shadowColor=`rgba(255,60,40,${0.25*pul})`;c.shadowBlur=12;c.shadowOffsetY=3;
      const pg=c.createLinearGradient(p.x,ty,p.x,ty+th);pg.addColorStop(0,`rgba(80,70,90,${0.6+urg*0.4})`);pg.addColorStop(0.5,`rgba(55,45,65,${0.6+urg*0.4})`);pg.addColorStop(1,`rgba(40,30,50,${0.6+urg*0.4})`);c.fillStyle=pg;roundRect(c,p.x,ty,p.w,th,6);c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
      c.strokeStyle=p.landed?`rgba(255,${50+urg*120},50,${0.3+pul*0.5})`:"rgba(150,140,170,0.3)";c.lineWidth=1.5;roundRect(c,p.x,ty,p.w,th,6);c.stroke();
      const isOn=egg.onPlatform===p;
      if(p.landed){c.fillStyle=secs<=2?`rgba(255,80,60,${0.7+pul*0.3})`:`rgba(255,220,150,${0.7+pul*0.3})`;c.font="bold 14px monospace";c.textAlign="center";c.textBaseline="middle";
        if(isOn)c.fillText(''+secs,p.x+p.w/2,ty+th/2);else{c.globalAlpha=0.5;c.fillText('â¸'+secs,p.x+p.w/2,ty+th/2);c.globalAlpha=1;}}
      else{c.fillStyle="rgba(200,180,220,0.5)";c.font="bold 10px monospace";c.textAlign="center";c.textBaseline="middle";c.fillText("5",p.x+p.w/2,ty+th/2);}
    }else if(p.type==="fragile"){
      const th=18,ty=p.y-4,wb=Math.sin(Date.now()/200)*1;
      c.shadowColor="rgba(255,180,50,0.55)";c.shadowBlur=16;c.shadowOffsetY=3;
      const pg=c.createLinearGradient(p.x,ty,p.x,ty+th);pg.addColorStop(0,"#F0C060");pg.addColorStop(0.15,"#E0A840");pg.addColorStop(0.5,"#CC8E30");pg.addColorStop(0.85,"#A06820");pg.addColorStop(1,"#7A4E18");c.fillStyle=pg;roundRect(c,p.x+wb,ty,p.w,th,3);c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
      c.strokeStyle="rgba(255,150,30,0.6)";c.lineWidth=1.5;roundRect(c,p.x+wb,ty,p.w,th,3);c.stroke();
      c.strokeStyle="rgba(80,45,10,0.25)";c.lineWidth=0.7;for(let i=0;i<4;i++){const ly=ty+3+i*(th-4)/4;c.beginPath();c.moveTo(p.x+wb+4,ly);for(let j=0;j<p.w-8;j+=8)c.quadraticCurveTo(p.x+wb+4+j+4,ly+Math.sin(j*0.3+i)*1.5,p.x+wb+4+j+8,ly);c.stroke();}
      c.strokeStyle="rgba(40,15,5,0.6)";c.lineWidth=1.8;const cx=p.x+wb+p.w*0.48;c.beginPath();c.moveTo(cx,ty+1);c.lineTo(cx+3,ty+th*0.35);c.lineTo(cx-3,ty+th*0.65);c.lineTo(cx+1,ty+th-1);c.stroke();
      c.fillStyle="#AAA09A";c.strokeStyle="rgba(60,40,20,0.7)";c.lineWidth=0.8;[p.x+wb+6,p.x+wb+p.w-6].forEach(nx=>{c.beginPath();c.arc(nx,ty+th/2,2.5,0,Math.PI*2);c.fill();c.stroke();});
      const lp=0.7+Math.sin(Date.now()/250)*0.3;c.fillStyle=`rgba(255,240,200,${lp})`;c.font="bold 11px monospace";c.textAlign="center";c.textBaseline="middle";c.fillText("1Ã—",p.x+wb+p.w/2,ty+th/2);
      c.fillStyle=`rgba(255,200,50,${lp})`;c.font="10px serif";c.textAlign="center";c.fillText("âš ",p.x+wb+p.w/2,ty-6);
    }else{
      c.shadowColor=`hsla(${p.hue},80%,60%,0.35)`;c.shadowBlur=12;c.shadowOffsetY=4;
      const pg=c.createLinearGradient(p.x,p.y-2,p.x,p.y+p.h+2);pg.addColorStop(0,`hsl(${p.hue},70%,65%)`);pg.addColorStop(1,`hsl(${p.hue},60%,45%)`);c.fillStyle=pg;roundRect(c,p.x,p.y,p.w,p.h,5);c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
      c.fillStyle=`hsla(${p.hue},80%,80%,0.35)`;roundRect(c,p.x+3,p.y+1,p.w-6,3,1.5);c.fill();
    }
  }
  // Birds
  for(const b of g.birds){const bsy=b.y-camera.y;if(bsy<-30||bsy>H+30)continue;c.font="22px serif";c.textAlign="center";c.textBaseline="middle";c.fillText(Math.sin(b.frame)>0?"ğŸ¦…":"ğŸ¦",b.x,b.y);}
  // Particles
  for(const p of g.particles){const a=Math.max(0,p.life/p.maxLife);c.fillStyle=`hsla(${p.hue},80%,70%,${a*0.8})`;c.beginPath();c.arc(p.x,p.y,p.size*a,0,Math.PI*2);c.fill();}
  // Landing FX
  if(g.landingFx){const fx=g.landingFx,isPf=fx.text.includes("PERFECT"),mt=isPf?40:20,a=Math.min(1,Math.max(0,fx.timer/mt));
    if(isPf){c.save();c.shadowColor=`rgba(255,200,50,${a*0.8})`;c.shadowBlur=20;c.fillStyle=`rgba(255,230,80,${a})`;c.font="bold 18px monospace";c.textAlign="center";c.fillText(fx.text,fx.x,fx.y-30+(1-a)*-25);c.restore();}
    else{c.fillStyle=`rgba(255,230,100,${a})`;c.font="bold 14px monospace";c.textAlign="center";c.fillText(fx.text,fx.x,fx.y-25+(1-a)*-15);}}
  // Egg
  const bob=g.state==="idle"?Math.sin(Date.now()/350)*3:g.state==="charging"?Math.sin(Date.now()/40)*2:0;
  const str=g.state==="jumping"&&egg.vy<-3?0.82:g.state==="jumping"&&egg.vy>3?1.18:1;
  c.save();c.translate(egg.x,egg.y+bob);
  if(evolveFlash){c.save();const ga=0.3+Math.sin(Date.now()/80)*0.25;c.shadowColor=`rgba(255,215,0,${ga})`;c.shadowBlur=40;c.fillStyle=`rgba(255,215,0,${ga*0.4})`;c.beginPath();c.arc(0,0,EGG_R*2.2,0,Math.PI*2);c.fill();c.restore();}
  c.scale(1/str,str);c.globalAlpha=1;c.shadowBlur=0;c.shadowColor="transparent";c.shadowOffsetX=0;c.shadowOffsetY=0;
  c.font=`${EGG_R*2.2}px serif`;c.textAlign="center";c.textBaseline="middle";c.fillStyle="#fff";c.fillText(STAGES[g.stageIdx].emoji,0,-1);
  c.restore();c.restore();

  // Power bar
  if(g.state==="idle"||g.state==="charging"){
    const bW=W-80,bH=20,bX=40,bY=H-58,pv=power.value,isM=pv>=99,mp=isM?0.6+Math.sin(Date.now()/80)*0.4:0;
    c.fillStyle=isM?`rgba(255,60,40,${0.25+mp*0.15})`:"rgba(30,40,80,0.85)";roundRect(c,bX-8,bY-26,bW+16,bH+46,14);c.fill();
    c.strokeStyle=isM?`rgba(255,80,50,${0.5+mp*0.5})`:"rgba(100,140,255,0.3)";c.lineWidth=1.5;roundRect(c,bX-8,bY-26,bW+16,bH+46,14);c.stroke();
    if(isM){c.shadowColor=`rgba(255,60,40,${mp})`;c.shadowBlur=20;roundRect(c,bX-8,bY-26,bW+16,bH+46,14);c.stroke();c.shadowBlur=0;}
    if(isM){c.fillStyle=`rgba(255,100,80,${0.7+mp*0.3})`;c.font="bold 10px monospace";c.textAlign="center";c.fillText("âš¡ MAX POWER! RELEASE! âš¡",W/2,bY-9);}
    else{c.fillStyle=g.state==="charging"?"rgba(255,220,80,0.85)":"rgba(180,200,255,0.6)";c.font="bold 9px monospace";c.textAlign="center";c.fillText(g.state==="charging"?"âš¡ CHARGING... RELEASE!":"âµ HOLD SPACE",W/2,bY-9);}
    const tg=c.createLinearGradient(bX,bY,bX,bY+bH);tg.addColorStop(0,"rgba(40,50,90,0.9)");tg.addColorStop(0.5,"rgba(30,35,70,0.9)");tg.addColorStop(1,"rgba(20,25,55,0.9)");c.fillStyle=tg;roundRect(c,bX,bY,bW,bH,10);c.fill();
    c.strokeStyle="rgba(100,130,200,0.25)";c.lineWidth=1;roundRect(c,bX,bY,bW,bH,10);c.stroke();
    const fW=(pv/100)*bW;const bg=c.createLinearGradient(bX,bY,bX+bW,bY);bg.addColorStop(0,"#22efb5");bg.addColorStop(0.35,"#40e070");bg.addColorStop(0.55,"#ffe040");bg.addColorStop(0.75,"#ff8c20");bg.addColorStop(0.9,"#ff4444");bg.addColorStop(1,"#ff2020");c.fillStyle=bg;
    if(isM){c.shadowColor=`rgba(255,60,40,${0.5+mp*0.5})`;c.shadowBlur=25;}else{c.shadowColor=pv>70?"rgba(255,140,30,0.4)":"rgba(50,230,150,0.4)";c.shadowBlur=12;}
    roundRect(c,bX,bY,Math.max(8,fW),bH,10);c.fill();c.shadowBlur=0;
    c.fillStyle="rgba(255,255,255,0.2)";roundRect(c,bX+2,bY+2,Math.max(4,fW-4),bH*0.35,6);c.fill();
    const ec=pv>85?"#ff4444":pv>60?"#ff8c20":"#22efb5";c.shadowColor=ec;c.shadowBlur=15;c.fillStyle="#fff";c.beginPath();c.arc(bX+fW,bY+bH/2,isM?6:4,0,Math.PI*2);c.fill();c.shadowBlur=0;
    const s1=bX+bW*0.6,s2=bX+bW*0.85;c.fillStyle="rgba(255,255,100,0.08)";roundRect(c,s1,bY,s2-s1,bH,0);c.fill();
    c.strokeStyle="rgba(255,255,255,0.3)";c.lineWidth=1;c.setLineDash([2,3]);[s1,s2].forEach(sx=>{c.beginPath();c.moveTo(sx,bY-2);c.lineTo(sx,bY+bH+2);c.stroke();});c.setLineDash([]);
    if(isM){c.fillStyle=`rgba(255,100,80,${0.8+mp*0.2})`;c.font="bold 14px monospace";}else{c.fillStyle="rgba(220,230,255,0.8)";c.font="bold 11px monospace";}
    c.textAlign="center";c.fillText(Math.floor(pv)+'%',W/2,bY+bH+17);
  }
  // Game over
  if(g.state==="gameover"){c.fillStyle="rgba(0,0,0,0.75)";c.fillRect(0,0,W,H);
    const fs=STAGES[g.stageIdx];c.font="60px serif";c.textAlign="center";c.fillText(fs.emoji,W/2,H/2-55);
    c.fillStyle="#fff";c.font="bold 22px monospace";c.fillText("GAME OVER",W/2,H/2+5);
    c.fillStyle="#fbbf24";c.font="bold 14px monospace";c.fillText(fs.name+' Â· '+g.score+'m Â· XP '+Math.floor(g.xp),W/2,H/2+35);
    if(g.highScore>0){c.fillStyle="rgba(255,255,255,0.35)";c.font="11px monospace";c.fillText('BEST: '+g.highScore+'m',W/2,H/2+58);}
    c.fillStyle="rgba(255,255,255,0.5)";c.font="12px monospace";c.fillText("TAP or SPACE to retry",W/2,H/2+95);}
}

// Input
window.addEventListener('keydown',e=>{if(e.code==='Space'||e.key===' '){e.preventDefault();if(e.repeat)return;if(g.state==='gameover')initGame();else startCharging();}});
window.addEventListener('keyup',e=>{if(e.code==='Space'||e.key===' '){e.preventDefault();releaseJump();}});
canvas.addEventListener('mousedown',e=>{e.preventDefault();if(g.state==='gameover')initGame();else startCharging();});
canvas.addEventListener('mouseup',e=>{e.preventDefault();releaseJump();});
canvas.addEventListener('touchstart',e=>{e.preventDefault();if(g.state==='gameover')initGame();else startCharging();},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();releaseJump();},{passive:false});

initGame();
requestAnimationFrame(loop);
})();
</script>
</body>
</html>
